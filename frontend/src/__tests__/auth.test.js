import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { login, logout, getToken, isAuthenticated, getCurrentUserInfo } from '@/lib/auth';
// Mock aws-amplify
vi.mock('aws-amplify', () => ({
    Amplify: {
        configure: vi.fn(),
    },
}));
vi.mock('aws-amplify/auth', () => ({
    signIn: vi.fn(),
    signOut: vi.fn(),
    getCurrentUser: vi.fn(),
    fetchAuthSession: vi.fn(),
}));
import { signIn, signOut, getCurrentUser, fetchAuthSession } from 'aws-amplify/auth';
describe('Auth Module', () => {
    beforeEach(() => {
        vi.clearAllMocks();
        localStorage.clear();
    });
    afterEach(() => {
        vi.clearAllMocks();
        localStorage.clear();
    });
    describe('login', () => {
        it('should sign in successfully and store token', async () => {
            const mockToken = {
                idToken: {
                    toString: () => 'mock-id-token-123',
                },
            };
            const mockSignInOutput = {
                isSignedIn: true,
            };
            vi.mocked(signIn).mockResolvedValue(mockSignInOutput);
            vi.mocked(fetchAuthSession).mockResolvedValue({
                tokens: mockToken,
            });
            const result = await login('teacher@example.com', 'password123');
            expect(signIn).toHaveBeenCalledWith({
                username: 'teacher@example.com',
                password: 'password123',
            });
            expect(result.isSignedIn).toBe(true);
            expect(localStorage.getItem('cognito_id_token')).toBe('mock-id-token-123');
        });
        it('should throw error on failed login', async () => {
            const error = new Error('Invalid credentials');
            error.name = 'NotAuthorizedException';
            vi.mocked(signIn).mockRejectedValue(error);
            await expect(login('teacher@example.com', 'wrong-password')).rejects.toThrow('Invalid credentials');
            expect(localStorage.getItem('cognito_id_token')).toBeNull();
        });
        it('should not store token if sign-in not complete', async () => {
            const mockSignInOutput = {
                isSignedIn: false,
            };
            vi.mocked(signIn).mockResolvedValue(mockSignInOutput);
            const result = await login('teacher@example.com', 'password123');
            expect(result.isSignedIn).toBe(false);
            expect(localStorage.getItem('cognito_id_token')).toBeNull();
        });
    });
    describe('logout', () => {
        it('should sign out and clear token', async () => {
            localStorage.setItem('cognito_id_token', 'existing-token');
            vi.mocked(signOut).mockResolvedValue(undefined);
            await logout();
            expect(signOut).toHaveBeenCalled();
            expect(localStorage.getItem('cognito_id_token')).toBeNull();
        });
        it('should clear token even if signOut fails', async () => {
            localStorage.setItem('cognito_id_token', 'existing-token');
            vi.mocked(signOut).mockRejectedValue(new Error('Sign out failed'));
            await expect(logout()).rejects.toThrow();
            expect(localStorage.getItem('cognito_id_token')).toBeNull();
        });
    });
    describe('getToken', () => {
        it('should get token from session', async () => {
            const mockToken = {
                idToken: {
                    toString: () => 'session-token-123',
                },
            };
            vi.mocked(fetchAuthSession).mockResolvedValue({
                tokens: mockToken,
            });
            const token = await getToken();
            expect(token).toBe('session-token-123');
            expect(localStorage.getItem('cognito_id_token')).toBe('session-token-123');
        });
        it('should fallback to localStorage if session has no token', async () => {
            localStorage.setItem('cognito_id_token', 'stored-token-123');
            vi.mocked(fetchAuthSession).mockResolvedValue({
                tokens: null,
            });
            const token = await getToken();
            expect(token).toBe('stored-token-123');
        });
        it('should return null if no token available', async () => {
            vi.mocked(fetchAuthSession).mockResolvedValue({
                tokens: null,
            });
            const token = await getToken();
            expect(token).toBeNull();
        });
        it('should handle errors gracefully', async () => {
            vi.mocked(fetchAuthSession).mockRejectedValue(new Error('Session error'));
            localStorage.setItem('cognito_id_token', 'fallback-token');
            const token = await getToken();
            expect(token).toBe('fallback-token');
        });
    });
    describe('isAuthenticated', () => {
        it('should return true when user is authenticated', async () => {
            vi.mocked(getCurrentUser).mockResolvedValue({
                userId: 'teacher-123',
                username: 'teacher@example.com',
            });
            const result = await isAuthenticated();
            expect(result).toBe(true);
        });
        it('should return false when user is not authenticated', async () => {
            vi.mocked(getCurrentUser).mockRejectedValue(new Error('Not authenticated'));
            const result = await isAuthenticated();
            expect(result).toBe(false);
        });
    });
    describe('getCurrentUserInfo', () => {
        it('should return user info when authenticated', async () => {
            const mockUser = {
                userId: 'teacher-123',
                username: 'teacher@example.com',
            };
            vi.mocked(getCurrentUser).mockResolvedValue(mockUser);
            const user = await getCurrentUserInfo();
            expect(user).toEqual(mockUser);
        });
        it('should return null when not authenticated', async () => {
            vi.mocked(getCurrentUser).mockRejectedValue(new Error('Not authenticated'));
            const user = await getCurrentUserInfo();
            expect(user).toBeNull();
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXV0aC50ZXN0LnRzeCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxRQUFRLENBQUE7QUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUV6RixtQkFBbUI7QUFDbkIsRUFBRSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUM1QixPQUFPLEVBQUU7UUFDUCxTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtLQUNuQjtDQUNGLENBQUMsQ0FBQyxDQUFBO0FBRUgsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO0lBQ2YsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7SUFDaEIsY0FBYyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7SUFDdkIsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRTtDQUMxQixDQUFDLENBQUMsQ0FBQTtBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBRXBGLFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO0lBQzNCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxFQUFFLENBQUMsYUFBYSxFQUFFLENBQUE7UUFDbEIsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFBO0lBQ3RCLENBQUMsQ0FBQyxDQUFBO0lBRUYsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNiLEVBQUUsQ0FB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LEdBQUcsTUFBTSxrQkFBa0IsRUFBRSxDQUFBO1lBRXZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDaEMsQ0FBQyxDQUFDLENBQUE7UUFFRixFQUFFLENBQUMsMkNBQTJDLEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDekQsRUFBRSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUE7WUFFM0UsTUFBTSxJQUFJLEdBQUcsTUFBTSxrQkFBa0IsRUFBRSxDQUFBO1lBRXZDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN6QixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgaXQsIGV4cGVjdCwgdmksIGJlZm9yZUVhY2gsIGFmdGVyRWFjaCB9IGZyb20gJ3ZpdGVzdCdcbmltcG9ydCB7IGxvZ2luLCBsb2dvdXQsIGdldFRva2VuLCBpc0F1dGhlbnRpY2F0ZWQsIGdldEN1cnJlbnRVc2VySW5mbyB9IGZyb20gJ0AvbGliL2F1dGgnXG5cbi8vIE1vY2sgYXdzLWFtcGxpZnlcbnZpLm1vY2soJ2F3cy1hbXBsaWZ5JywgKCkgPT4gKHtcbiAgQW1wbGlmeToge1xuICAgIGNvbmZpZ3VyZTogdmkuZm4oKSxcbiAgfSxcbn0pKVxuXG52aS5tb2NrKCdhd3MtYW1wbGlmeS9hdXRoJywgKCkgPT4gKHtcbiAgc2lnbkluOiB2aS5mbigpLFxuICBzaWduT3V0OiB2aS5mbigpLFxuICBnZXRDdXJyZW50VXNlcjogdmkuZm4oKSxcbiAgZmV0Y2hBdXRoU2Vzc2lvbjogdmkuZm4oKSxcbn0pKVxuXG5pbXBvcnQgeyBzaWduSW4sIHNpZ25PdXQsIGdldEN1cnJlbnRVc2VyLCBmZXRjaEF1dGhTZXNzaW9uIH0gZnJvbSAnYXdzLWFtcGxpZnkvYXV0aCdcblxuZGVzY3JpYmUoJ0F1dGggTW9kdWxlJywgKCkgPT4ge1xuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICB2aS5jbGVhckFsbE1vY2tzKClcbiAgICBsb2NhbFN0b3JhZ2UuY2xlYXIoKVxuICB9KVxuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgdmkuY2xlYXJBbGxNb2NrcygpXG4gICAgbG9jYWxTdG9yYWdlLmNsZWFyKClcbiAgfSlcblxuICBkZXNjcmliZSgnbG9naW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzaWduIGluIHN1Y2Nlc3NmdWxseSBhbmQgc3RvcmUgdG9rZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrVG9rZW4gPSB7XG4gICAgICAgIGlkVG9rZW46IHtcbiAgICAgICAgICB0b1N0cmluZzogKCkgPT4gJ21vY2staWQtdG9rZW4tMTIzJyxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgY29uc3QgbW9ja1NpZ25Jbk91dHB1dCA9IHtcbiAgICAgICAgaXNTaWduZWRJbjogdHJ1ZSxcbiAgICAgIH1cblxuICAgICAgdmkubW9ja2VkKHNpZ25JbikubW9ja1Jlc29sdmVkVmFsdWUobW9ja1NpZ25Jbk91dHB1dCBhcyBhbnkpXG4gICAgICB2aS5tb2NrZWQoZmV0Y2hBdXRoU2Vzc2lvbikubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICB0b2tlbnM6IG1vY2tUb2tlbixcbiAgICAgIH0gYXMgYW55KVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBsb2dpbigndGVhY2hlckBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXG5cbiAgICAgIGV4cGVjdChzaWduSW4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgdXNlcm5hbWU6ICd0ZWFjaGVyQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMycsXG4gICAgICB9KVxuICAgICAgZXhwZWN0KHJlc3VsdC5pc1NpZ25lZEluKS50b0JlKHRydWUpXG4gICAgICBleHBlY3QobG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2NvZ25pdG9faWRfdG9rZW4nKSkudG9CZSgnbW9jay1pZC10b2tlbi0xMjMnKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIG9uIGZhaWxlZCBsb2dpbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKCdJbnZhbGlkIGNyZWRlbnRpYWxzJylcbiAgICAgIGVycm9yLm5hbWUgPSAnTm90QXV0aG9yaXplZEV4Y2VwdGlvbidcbiAgICAgIHZpLm1vY2tlZChzaWduSW4pLm1vY2tSZWplY3RlZFZhbHVlKGVycm9yKVxuXG4gICAgICBhd2FpdCBleHBlY3QobG9naW4oJ3RlYWNoZXJAZXhhbXBsZS5jb20nLCAnd3JvbmctcGFzc3dvcmQnKSkucmVqZWN0cy50b1Rocm93KCdJbnZhbGlkIGNyZWRlbnRpYWxzJylcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29nbml0b19pZF90b2tlbicpKS50b0JlTnVsbCgpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgbm90IHN0b3JlIHRva2VuIGlmIHNpZ24taW4gbm90IGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja1NpZ25Jbk91dHB1dCA9IHtcbiAgICAgICAgaXNTaWduZWRJbjogZmFsc2UsXG4gICAgICB9XG5cbiAgICAgIHZpLm1vY2tlZChzaWduSW4pLm1vY2tSZXNvbHZlZFZhbHVlKG1vY2tTaWduSW5PdXRwdXQgYXMgYW55KVxuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBsb2dpbigndGVhY2hlckBleGFtcGxlLmNvbScsICdwYXNzd29yZDEyMycpXG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNTaWduZWRJbikudG9CZShmYWxzZSlcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29nbml0b19pZF90b2tlbicpKS50b0JlTnVsbCgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnbG9nb3V0JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2lnbiBvdXQgYW5kIGNsZWFyIHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NvZ25pdG9faWRfdG9rZW4nLCAnZXhpc3RpbmctdG9rZW4nKVxuICAgICAgdmkubW9ja2VkKHNpZ25PdXQpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCBhcyBhbnkpXG5cbiAgICAgIGF3YWl0IGxvZ291dCgpXG5cbiAgICAgIGV4cGVjdChzaWduT3V0KS50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29nbml0b19pZF90b2tlbicpKS50b0JlTnVsbCgpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgY2xlYXIgdG9rZW4gZXZlbiBpZiBzaWduT3V0IGZhaWxzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NvZ25pdG9faWRfdG9rZW4nLCAnZXhpc3RpbmctdG9rZW4nKVxuICAgICAgdmkubW9ja2VkKHNpZ25PdXQpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignU2lnbiBvdXQgZmFpbGVkJykpXG5cbiAgICAgIGF3YWl0IGV4cGVjdChsb2dvdXQoKSkucmVqZWN0cy50b1Rocm93KClcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29nbml0b19pZF90b2tlbicpKS50b0JlTnVsbCgpXG4gICAgfSlcbiAgfSlcblxuICBkZXNjcmliZSgnZ2V0VG9rZW4nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBnZXQgdG9rZW4gZnJvbSBzZXNzaW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja1Rva2VuID0ge1xuICAgICAgICBpZFRva2VuOiB7XG4gICAgICAgICAgdG9TdHJpbmc6ICgpID0+ICdzZXNzaW9uLXRva2VuLTEyMycsXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIHZpLm1vY2tlZChmZXRjaEF1dGhTZXNzaW9uKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIHRva2VuczogbW9ja1Rva2VuLFxuICAgICAgfSBhcyBhbnkpXG5cbiAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0VG9rZW4oKVxuXG4gICAgICBleHBlY3QodG9rZW4pLnRvQmUoJ3Nlc3Npb24tdG9rZW4tMTIzJylcbiAgICAgIGV4cGVjdChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnY29nbml0b19pZF90b2tlbicpKS50b0JlKCdzZXNzaW9uLXRva2VuLTEyMycpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgZmFsbGJhY2sgdG8gbG9jYWxTdG9yYWdlIGlmIHNlc3Npb24gaGFzIG5vIHRva2VuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ2NvZ25pdG9faWRfdG9rZW4nLCAnc3RvcmVkLXRva2VuLTEyMycpXG4gICAgICB2aS5tb2NrZWQoZmV0Y2hBdXRoU2Vzc2lvbikubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICB0b2tlbnM6IG51bGwsXG4gICAgICB9IGFzIGFueSlcblxuICAgICAgY29uc3QgdG9rZW4gPSBhd2FpdCBnZXRUb2tlbigpXG5cbiAgICAgIGV4cGVjdCh0b2tlbikudG9CZSgnc3RvcmVkLXRva2VuLTEyMycpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgaWYgbm8gdG9rZW4gYXZhaWxhYmxlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgdmkubW9ja2VkKGZldGNoQXV0aFNlc3Npb24pLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgdG9rZW5zOiBudWxsLFxuICAgICAgfSBhcyBhbnkpXG5cbiAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0VG9rZW4oKVxuXG4gICAgICBleHBlY3QodG9rZW4pLnRvQmVOdWxsKClcbiAgICB9KVxuXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgZXJyb3JzIGdyYWNlZnVsbHknLCBhc3luYyAoKSA9PiB7XG4gICAgICB2aS5tb2NrZWQoZmV0Y2hBdXRoU2Vzc2lvbikubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdTZXNzaW9uIGVycm9yJykpXG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnY29nbml0b19pZF90b2tlbicsICdmYWxsYmFjay10b2tlbicpXG5cbiAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0VG9rZW4oKVxuXG4gICAgICBleHBlY3QodG9rZW4pLnRvQmUoJ2ZhbGxiYWNrLXRva2VuJylcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdpc0F1dGhlbnRpY2F0ZWQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSB3aGVuIHVzZXIgaXMgYXV0aGVudGljYXRlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHZpLm1vY2tlZChnZXRDdXJyZW50VXNlcikubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICB1c2VySWQ6ICd0ZWFjaGVyLTEyMycsXG4gICAgICAgIHVzZXJuYW1lOiAndGVhY2hlckBleGFtcGxlLmNvbScsXG4gICAgICB9IGFzIGFueSlcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaXNBdXRoZW50aWNhdGVkKClcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKVxuICAgIH0pXG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBmYWxzZSB3aGVuIHVzZXIgaXMgbm90IGF1dGhlbnRpY2F0ZWQnLCBhc3luYyAoKSA9PiB7XG4gICAgICB2aS5tb2NrZWQoZ2V0Q3VycmVudFVzZXIpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignTm90IGF1dGhlbnRpY2F0ZWQnKSlcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaXNBdXRoZW50aWNhdGVkKClcblxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZShmYWxzZSlcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdnZXRDdXJyZW50VXNlckluZm8nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdXNlciBpbmZvIHdoZW4gYXV0aGVudGljYXRlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tVc2VyID0ge1xuICAgICAgICB1c2VySWQ6ICd0ZWFjaGVyLTEyMycsXG4gICAgICAgIHVzZXJuYW1lOiAndGVhY2hlckBleGFtcGxlLmNvbScsXG4gICAgICB9XG5cbiAgICAgIHZpLm1vY2tlZChnZXRDdXJyZW50VXNlcikubW9ja1Jlc29sdmVkVmFsdWUobW9ja1VzZXIgYXMgYW55KVxuXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgZ2V0Q3VycmVudFVzZXJJbmZvKClcblxuICAgICAgZXhwZWN0KHVzZXIpLnRvRXF1YWwobW9ja1VzZXIpXG4gICAgfSlcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIG51bGwgd2hlbiBub3QgYXV0aGVudGljYXRlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIHZpLm1vY2tlZChnZXRDdXJyZW50VXNlcikubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdOb3QgYXV0aGVudGljYXRlZCcpKVxuXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgZ2V0Q3VycmVudFVzZXJJbmZvKClcblxuICAgICAgZXhwZWN0KHVzZXIpLnRvQmVOdWxsKClcbiAgICB9KVxuICB9KVxufSlcblxuIl19